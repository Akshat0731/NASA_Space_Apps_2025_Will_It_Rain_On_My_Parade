<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Star Forger - 2D Weather Analysis</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      display: flex;
      overflow: hidden;
      color: #e0f7fa;
      background: #000;
    }

    #map {
      flex: 2;
      height: 100vh;
      background-color: #1a1a1a;
    }

    #sidebar {
      flex: 1;
      height: 100vh;
      padding: 20px;
      background: rgba(0, 0, 30, 0.85);
      border-left: 2px solid rgba(79, 195, 247, 0.4);
      overflow-y: auto;
      box-sizing: border-box;
    }

    h2,
    h3 {
      color: #81d4fa;
      text-shadow: 0 0 10px #2196f3;
    }

    h2 {
      margin-top: 0;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      color: #4fc3f7;
    }

    input[type="text"],
    input[type="datetime-local"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      outline: none;
      background: rgba(255, 255, 255, 0.1);
      color: #e0f7fa;
      box-shadow: 0 0 8px #2196f3 inset;
      margin-top: 5px;
      box-sizing: border-box;
    }

    button {
      background: #2196f3;
      color: white;
      cursor: pointer;
      font-weight: bold;
      padding: 10px;
      margin-top: 10px;
      width: 100%;
      border-radius: 8px;
      border: none;
      transition: 0.3s;
    }

    button:hover {
      background: #1976d2;
      box-shadow: 0 0 10px #2196f3;
    }

    .data-box {
      background: rgba(0, 0, 50, 0.6);
      padding: 15px;
      margin-top: 15px;
      border-radius: 12px;
      color: #81d4fa;
      font-family: monospace;
      box-shadow: 0 0 10px #2196f3 inset;
      word-wrap: break-word;
    }

    .prediction-box {
      margin-top: 10px;
      padding: 10px;
      background: rgba(0, 30, 50, 0.7);
      border-radius: 8px;
      color: #fff;
      text-align: center;
      font-weight: bold;
      text-shadow: 0 0 8px #2196f3;
    }

    .suggestions {
      position: absolute;
      background: rgba(0, 20, 40, 0.95);
      border-radius: 6px;
      border: 1px solid #4fc3f7;
      max-height: 180px;
      overflow-y: auto;
      z-index: 1000;
      width: 100%;
      box-sizing: border-box;
    }

    .suggestions div {
      padding: 8px 10px;
      cursor: pointer;
      color: #bbdefb;
    }

    .suggestions div:hover {
      background: rgba(33, 150, 243, 0.6);
      color: #fff;
    }

    .sidebar-section {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid rgba(79, 195, 247, 0.3);
    }

    .date-controls {
      display: flex;
      gap: 10px;
    }

    .date-controls button {
      margin-top: 5px;
      background: rgba(33, 150, 243, 0.5);
    }

    .toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0, 20, 40, 0.5);
      padding: 10px 15px;
      border-radius: 12px;
      margin: 8px 0;
    }

    .toggle span {
      font-weight: bold;
      color: #4fc3f7;
    }

    .switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: rgba(33, 150, 243, 0.2);
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 4px;
      width: 18px;
      height: 18px;
      background: #81d4fa;
      border-radius: 50%;
      transition: transform 0.3s;
      box-shadow: 0 0 10px #2196f3;
    }

    .switch.on {
      background: rgba(33, 150, 243, 0.8);
    }

    .switch.on::after {
      transform: translateX(24px);
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="sidebar">
    <h2>üåå Weather & NASA Layers</h2>

    <label for="locationInput">Enter Location:</label>
    <div style="position:relative;">
      <input type="text" id="locationInput" placeholder="Enter a location..." oninput="showSuggestions(this.value)" />
      <div class="suggestions" id="suggestionsBox"></div>
    </div>

    <label for="datetimeInput">Select Date & Time:</label>
    <input type="datetime-local" id="datetimeInput" step="1" />
    <div class="date-controls">
      <button onclick="changeDate(-1)">¬´ Previous Day</button>
      <button onclick="changeDate(1)">Next Day ¬ª</button>
    </div>
    <button onclick="getWeatherByName()">Get Weather</button>

    <div class="data-box" id="results">‚ú® Click on map or search for a location...</div>
    <div class="prediction-box" id="prediction">üîÆ Weather prediction appears here...</div>

    <div class="sidebar-section">
      <h3>Day / Night</h3>
      <button onclick="setTile('day')">‚òÄÔ∏è Day</button>
      <button onclick="setTile('night')">üåô Night</button>
    </div>

    <div class="sidebar-section">
      <h3>NASA Layers</h3>
      <div class="toggle"><span>‚òÅÔ∏è VIIRS Clouds</span>
        <div class="switch" id="VIIRS" onclick="selectLayer('VIIRS')"></div>
      </div>
      <div class="toggle"><span>üõ∞Ô∏è MODIS Aqua</span>
        <div class="switch" id="MODIS_Aqua" onclick="selectLayer('MODIS_Aqua')"></div>
      </div>
      <div class="toggle"><span>üõ∞Ô∏è MODIS Terra</span>
        <div class="switch" id="MODIS_Terra" onclick="selectLayer('MODIS_Terra')"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- MAP INITIALIZATION ---
    const mapBounds = L.latLngBounds(L.latLng(-90, -180), L.latLng(90, 180));
    const map = L.map('map', {
      maxZoom: 16,
      minZoom: 2,
      maxBounds: mapBounds, // Prevents panning outside the single world view
      maxBoundsViscosity: 1.0 // Makes the bounds solid
    }).setView([20, 77], 3);

    // Define the two base map layers (day and night)
    let dayLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap', noWrap: true });
    let nightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 19, noWrap: true });
    dayLayer.addTo(map);

    let marker; // This variable will hold the user's selected location marker

    // --- NASA GIBBS LAYERS ---
    const overlays = {};
    const layerIds = ['VIIRS', 'MODIS_Aqua', 'MODIS_Terra'];
    let activeLayerId = null;

    // Handles toggling the NASA satellite imagery layers on the map.
    function toggleLayer(layerId, state) {
      const dateStr = (document.getElementById('datetimeInput').value || new Date().toISOString()).split('T')[0];
      if (overlays[layerId]) {
        map.removeLayer(overlays[layerId]);
        overlays[layerId] = null;
      }
      if (state) {
        let layerName = '';
        switch (layerId) {
          case 'VIIRS': layerName = 'VIIRS_NOAA20_CorrectedReflectance_TrueColor'; break;
          case 'MODIS_Aqua': layerName = 'MODIS_Aqua_CorrectedReflectance_TrueColor'; break;
          case 'MODIS_Terra': layerName = 'MODIS_Terra_CorrectedReflectance_TrueColor'; break;
        }
        overlays[layerId] = L.tileLayer(
          `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${layerName}/default/${dateStr}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`,
          { attribution: 'NASA GIBS', maxNativeZoom: 9, maxZoom: 16, noWrap: true, bounds: mapBounds }
        ).addTo(map);
      }
    }

    // --- UI EVENT HANDLERS ---

    // Handles clicks on the satellite layer toggle switches.
    function selectLayer(selectedId) {
      const clickedElement = document.getElementById(selectedId);
      const wasActive = clickedElement.classList.contains('on');
      layerIds.forEach(id => {
        document.getElementById(id).classList.remove('on');
        toggleLayer(id, false);
      });
      if (!wasActive) {
        clickedElement.classList.add('on');
        toggleLayer(selectedId, true);
        activeLayerId = selectedId;
      } else {
        activeLayerId = null;
      }
    }

    // Handles clicks on the "Previous/Next Day" buttons.
    function changeDate(days) {
      const dtInput = document.getElementById('datetimeInput');
      let currentDate = dtInput.value ? new Date(dtInput.value) : new Date();
      currentDate.setDate(currentDate.getDate() + days);
      dtInput.value = currentDate.toISOString().slice(0, 16);
      if (activeLayerId) {
        toggleLayer(activeLayerId, true); // Refresh NASA layer
      }
      autoTile(); // Switch to day/night map if needed
    }

    // Switches the base map between day and night themes.
    function setTile(mode) {
      if (mode === 'day' && !map.hasLayer(dayLayer)) {
        map.removeLayer(nightLayer);
        dayLayer.addTo(map);
      } else if (mode === 'night' && !map.hasLayer(nightLayer)) {
        map.removeLayer(dayLayer);
        nightLayer.addTo(map);
      }
    }

    // Automatically sets day/night theme based on the selected time.
    function autoTile() {
      const dt = document.getElementById('datetimeInput').value;
      const hour = dt ? new Date(dt).getHours() : new Date().getHours();
      setTile(hour >= 6 && hour < 18 ? 'day' : 'night');
    }

    // Listens for any change in the date/time input field.
    document.getElementById('datetimeInput').addEventListener('change', () => {
      if (activeLayerId) {
        toggleLayer(activeLayerId, true);
      }
      autoTile();
    });

    // --- GEOLOCATION & API FUNCTIONS ---

    // Fetches the address for a given lat/lon using reverse geocoding.
    async function reverseGeocode(lat, lon) {
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
        const data = await res.json();
        return data.display_name || `${lat.toFixed(4)},${lon.toFixed(4)}`;
      } catch {
        return `${lat.toFixed(4)},${lon.toFixed(4)}`;
      }
    }

    // Handles click events on the map to set a location marker.
    map.on('click', async e => {
      const { lat, lng } = e.latlng;
      const dtInput = document.getElementById('datetimeInput');
      if (!dtInput.value) { dtInput.value = new Date().toISOString().slice(0, 16); }

      const name = await reverseGeocode(lat, lng);
      document.getElementById('locationInput').value = name;

      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map).bindPopup(name).openPopup();

      autoTile();
    });

    // Fetches location suggestions as the user types in the search box.
    async function showSuggestions(query) {
      const box = document.getElementById('suggestionsBox');
      box.innerHTML = "";
      if (query.length < 3) return;
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
        const data = await res.json();
        data.forEach(place => {
          const div = document.createElement('div');
          div.textContent = place.display_name;
          div.onclick = () => {
            document.getElementById('locationInput').value = place.display_name;
            box.innerHTML = "";
            getWeatherByName(); // Automatically fetch weather after selection
          };
          box.appendChild(div);
        });
      } catch (e) { console.error(e); }
    }

    // Fetches weather when the user searches for a location by name.
    async function getWeatherByName() {
      const loc = document.getElementById('locationInput').value;
      const dt = document.getElementById('datetimeInput').value;
      const resBox = document.getElementById('results');
      if (!loc || !dt) {
        resBox.innerText = "‚ö†Ô∏è Please enter a location and select a date/time.";
        return;
      }
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(loc)}`);
        const data = await res.json();
        if (!data.length) {
          resBox.innerText = "‚ùå Location not found.";
          return;
        }
        const { lat, lon, display_name } = data[0];
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lon]).addTo(map).bindPopup(display_name).openPopup();
        map.setView([lat, lon], 7);
        autoTile();
      } catch (e) {
        resBox.innerText = "‚ùå Error fetching location data.";
        console.error(e);
      }
    }

    // On page load, try to get the user's current location to populate the search box.
    window.addEventListener('load', () => {
      const input = document.getElementById('locationInput');
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async pos => {
          input.placeholder = "Fetching your location...";
          const { latitude, longitude } = pos.coords;
          const name = await reverseGeocode(latitude, longitude);
          input.value = name;
          if (marker) map.removeLayer(marker);
          marker = L.marker([latitude, longitude]).addTo(map).bindPopup(name).openPopup();
          map.setView([latitude, longitude], 7);
        }, () => { input.placeholder = "Enter location manually"; });
      } else {
        input.placeholder = "Enter location manually";
      }
    });

    // Fetches the historical analysis from our Python backend.
    async function fetchHistoricalAnalysis() {
      if (!marker) {
        alert("Please click a location on the map first.");
        return;
      }
      const dtInput = document.getElementById('datetimeInput').value;
      if (!dtInput) {
        alert("Please select a date and time first.");
        return;
      }

      // Define a default set of simple conditions to analyze automatically.
      const simpleConditions = "precipitation_gt_25,wind_speed_gt_10";

      const resultsBox = document.getElementById('results');
      const predBox = document.getElementById('prediction');
      resultsBox.innerHTML = "<b>üìä Analyzing historical data... Please wait.</b>";
      predBox.innerText = "";

      try {
        // Construct the URL and call the /analyze endpoint on our Flask server.
        const url = `/analyze?lat=${marker.getLatLng().lat}&lon=${marker.getLatLng().lng}&month=${new Date(dtInput).getMonth() + 1}&day=${new Date(dtInput).getDate()}&conditions=${encodeURIComponent(simpleConditions)}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) {
          resultsBox.innerText = "‚ùå " + data.error;
          return;
        }

        // Format and display the results from the backend.
        let outputHTML = "<b>üìä Historical Weather Analysis:</b><br>";
        data.probabilities.forEach(p => {
          outputHTML += `-> ${p.condition}: <b>${p.probability}%</b> chance<br>`;
        });
        resultsBox.innerHTML = outputHTML;
        predBox.innerText = "üîÆ Analysis complete.";

      } catch (e) {
        resultsBox.innerText = "‚ùå Error fetching analysis results.";
        console.error(e);
      }
    }

    // Creates the "Analyze" button and adds it to the sidebar.
    const analysisBtn = document.createElement('button');
    analysisBtn.innerText = "üìà Analyze Historical Weather";
    analysisBtn.onclick = fetchHistoricalAnalysis;
    document.getElementById('sidebar').appendChild(analysisBtn);

    // Set a default datetime on page load
    document.getElementById('datetimeInput').value = new Date().toISOString().slice(0, 16);
  </script>
</body>

</html>